<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1">
    
    <!-- Cache-Control: Sofortige Updates erzwingen -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA Meta-Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Patientenpfade: ZNA">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff" id="metaThemeColor">
    <meta name="description" content="Patientenpfade: ZNA – Standardarbeitsanweisungen für die Notaufnahme">
    <meta name="format-detection" content="telephone=no">
    
    <!-- iOS Splash Screens -->
    <meta name="apple-touch-fullscreen" content="yes">
    
    <!-- Performance Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Critical CSS Preload -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="app.js" as="script">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon und Apple Touch Icon -->
    <link rel="icon" type="image/png" href="img/Patientenpfade.png">
    <link rel="apple-touch-icon" href="img/Patientenpfade.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/Patientenpfade.png">
    
    <title>Patientenpfade: ZNA</title>
</head>
<body>
    <div id="app" class="app-shell">
        <header class="mobile-header" id="mobileHeader">
            <div class="mobile-header-inner">
                <div class="mobile-header-left">
                    <button class="header-btn hidden" id="backBtn" aria-label="Zurück">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                </div>
                <div class="mobile-header-center">
                    <span class="mobile-title" id="mobileTitle">Patientenpfade: ZNA</span>
                </div>
                <div class="mobile-header-right">
                    <button class="header-btn" id="themeToggleMobile" aria-label="Theme wechseln">
                        <i class="fa-solid fa-moon" id="themeToggleMobileIcon"></i>
                    </button>
                </div>
            </div>
        </header>
        <aside class="sidebar desktop-only" id="sidebar">
            <div class="sidebar-header">
                <div class="app-logo" id="appLogo">
                    <img src="img/Patientenpfade.png" alt="Patientenpfade" class="logo-image">
                    <div class="logo-text">
                        <span class="logo-main">Patientenpfade: ZNA</span>
                        <span class="logo-sub">SOPs für die Notaufnahme</span>
                        <span class="logo-sub-2">AG Klinische Pfade</span>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Suche..." autocomplete="off" spellcheck="false">
                    <button class="search-clear-btn" id="searchClear" aria-label="Suche löschen">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <div class="sidebar-category-wrap">
                <div class="category-filters" id="categoryFilters"></div>
            </div>
            <nav class="nav-list" id="navList" aria-label="SOP-Verzeichnis"></nav>
            <div class="sidebar-footer">
                <button class="theme-toggle" id="themeToggle" aria-label="Theme wechseln">
                    <i class="fa-solid fa-moon" id="themeToggleIcon"></i>
                    <span id="themeToggleLabel">Dark Mode</span>
                </button>
            </div>
        </aside>
        <main class="main-content" id="mainContent">
            <div class="content-header desktop-only" id="contentHeader">
                <div class="breadcrumb" id="breadcrumb"></div>
                <div class="header-tools">
                    <button class="icon-btn" id="desktopTocBtn" title="Inhaltsverzeichnis" aria-label="Inhaltsverzeichnis" style="display:none;">
                        <i class="fa-solid fa-list-ul"></i>
                    </button>
                </div>
            </div>
            <div class="content-scroll" id="contentScroll">
                <div id="viewHome" class="view-panel view-pad"></div>
                <div id="viewBrowse" class="view-panel" style="display:none;">
                    <div class="browse-search-wrap">
                        <div class="browse-search-input-wrapper">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" id="browseSearchInput" placeholder="SOP filtern..." autocomplete="off" spellcheck="false">
                            <button class="search-clear-btn" id="browseSearchClear" aria-label="Filter löschen">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="browse-category-wrap">
                        <div class="browse-category-filters" id="browseCategoryFilters"></div>
                    </div>
                    <div class="browse-list" id="browseList"></div>
                </div>
                <div id="viewSearch" class="view-panel" style="display:none;">
                    <div class="search-view-wrap">
                        <div class="search-view-input-wrapper">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" id="searchViewInput" placeholder="Volltextsuche in allen SOPs..." autocomplete="off" spellcheck="false">
                            <button class="search-clear-btn" id="searchViewClear" aria-label="Suche löschen">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div id="searchResultsArea"></div>
                </div>
                <div id="viewSOP" class="view-panel" style="display:none;"></div>
            </div>
        </main>
        <button class="fab" id="fabAction" aria-label="Inhaltsverzeichnis">
            <i class="fa-solid fa-list-ul"></i>
        </button>
        <div class="section-picker-overlay" id="sectionPickerOverlay">
            <div class="section-picker-backdrop" id="sectionPickerBackdrop"></div>
            <div class="section-picker" id="sectionPicker">
                <div class="section-picker-handle"></div>
                <div class="section-picker-header">
                    <span class="section-picker-title">Inhaltsverzeichnis</span>
                    <button class="section-picker-close" id="sectionPickerClose" aria-label="Schließen">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="section-picker-list" id="sectionPickerList"></div>
                <div class="section-picker-action" id="sectionPickerPrint">
                    <i class="fa-solid fa-print"></i>
                    <span>SOP drucken</span>
                </div>
            </div>
        </div>
        <nav class="bottom-nav" id="bottomNav" aria-label="Hauptnavigation">
            <button class="bottom-nav-item active" data-tab="home" aria-label="Übersicht">
                <i class="fa-solid fa-house"></i>
                <span>Übersicht</span>
            </button>
            <button class="bottom-nav-item" data-tab="browse" aria-label="Alle SOPs durchsuchen">
                <i class="fa-solid fa-list"></i>
                <span>Alle SOPs</span>
            </button>
            <button class="bottom-nav-item" data-tab="search" aria-label="Volltextsuche">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>Suche</span>
            </button>
        </nav>
    </div>
    <!-- SOP-Dateien -->
    <script src="sops/abdominelle-schmerzen.js"></script>
    <script src="sops/aecopd.js"></script>
    <script src="sops/akute-alkoholintoxikation.js"></script>
    <script src="sops/akute-divertikulitis.js"></script>
    <script src="sops/akute-gastroenteritis.js"></script>
    <script src="sops/akute-herzinsuffizienz.js"></script>
    <script src="sops/akute-intoxikation.js"></script>
    <script src="sops/akute-mesenterialischaemie.js"></script>
    <script src="sops/akute-nebenniereninsuffizienz.js"></script>
    <script src="sops/akute-nierenschaedigung.js"></script>
    <script src="sops/akute-pankreatitis.js"></script>
    <script src="sops/akuter-gichtanfall.js"></script>
    <script src="sops/akuter-harnverhalt.js"></script>
    <script src="sops/akutes-aortensyndrom.js"></script>
    <script src="sops/anaemie.js"></script>
    <script src="sops/anaphylaxie.js"></script>
    <script src="sops/asthmaexazerbation.js"></script>
    <script src="sops/bakterielle-meningitis.js"></script>
    <script src="sops/bradykarde-hrst.js"></script>
    <script src="sops/cannabinoid-hyperemesis-syndrom.js"></script>
    <script src="sops/delir.js"></script>
    <script src="sops/diabetische-ketoazidose.js"></script>
    <script src="sops/dyspnoe.js"></script>
    <script src="sops/erbrechen.js"></script>
    <script src="sops/erysipel.js"></script>
    <script src="sops/fieber-in-der-neutropenie.js"></script>
    <script src="sops/fremdkoerperingestion.js"></script>
    <script src="sops/harnwegsinfektion.js"></script>
    <script src="sops/heparininduzierte-thrombozytopenie.js"></script>
    <script src="sops/hepatische-enzephalopathie.js"></script>
    <script src="sops/herz-kreislauf-stillstand.js"></script>
    <script src="sops/hitzschlag.js"></script>
    <script src="sops/hyperkaliaemie.js"></script>
    <script src="sops/hyperkalzaemie.js"></script>
    <script src="sops/hypernatriaemie.js"></script>
    <script src="sops/hyperosmolares-hyperglykaemisches-syndrom.js"></script>
    <script src="sops/hypertensiver-notfall.js"></script>
    <script src="sops/hypoglykaemie.js"></script>
    <script src="sops/hypokaliaemie.js"></script>
    <script src="sops/hypokalzaemie.js"></script>
    <script src="sops/hyponatriaemie.js"></script>
    <script src="sops/ikterus.js"></script>
    <script src="sops/kohlenmonoxidintoxikation.js"></script>
    <script src="sops/kopfschmerzen.js"></script>
    <script src="sops/lungenarterienembolie.js"></script>
    <script src="sops/myxoedemkoma.js"></script>
    <script src="sops/nicht-st-hebungsinfarkt.js"></script>
    <script src="sops/nierenkolik.js"></script>
    <script src="sops/obere-gastrointestinale-blutung.js"></script>
    <script src="sops/oesophageale-bolusimpaktion.js"></script>
    <script src="sops/pleuraerguss.js"></script>
    <script src="sops/pneumonie.js"></script>
    <script src="sops/schock.js"></script>
    <script src="sops/sepsis.js"></script>
    <script src="sops/spontan-bakterielle-peritonitis.js"></script>
    <script src="sops/st-hebungsinfarkt.js"></script>
    <script src="sops/status-epilepticus.js"></script>
    <script src="sops/sterbephase-palliativ.js"></script>
    <script src="sops/stromunfall.js"></script>
    <script src="sops/synkope.js"></script>
    <script src="sops/tachykarde-hrst.js"></script>
    <script src="sops/thoraxschmerzen.js"></script>
    <script src="sops/thrombozytopenie.js"></script>
    <script src="sops/tiefe-venenthrombose.js"></script>
    <script src="sops/tonsillitis.js"></script>
    <script src="sops/transiente-globale-amnesie.js"></script>
    <script src="sops/tumorlysesyndrom.js"></script>
    <script src="sops/unklare-vigilanzminderung.js"></script>
    <script src="sops/untere-gastrointestinale-blutung.js"></script>
    <script src="sops/vena-cava-superior-syndrom.js"></script>
    <script src="sops/vorhofflimmern.js"></script>
    <script src="sops/zerebrale-metastasen.js"></script>
    <script src="sops/zerebrale-venen-sinusthrombose.js"></script>
    <!-- App -->
    <script src="app.js"></script>
    <script>
        (function() {
            if (!('serviceWorker' in navigator)) return;

            var swRegistration = null;
            var isReloading = false;

            // Service Worker registrieren
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
                    .then(function(reg) {
                        swRegistration = reg;
                        console.log('[SW] Registriert:', reg.scope);

                        // Prüfen ob ein neuer SW wartet
                        if (reg.waiting) {
                            console.log('[SW] Wartender SW gefunden - aktiviere');
                            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }

                        // Auf Updates prüfen
                        reg.update().catch(function() {});
                    })
                    .catch(function(err) {
                        console.log('[SW] Registrierung fehlgeschlagen:', err);
                    });
            });

            // Bei jedem Seitenaufruf auf Updates prüfen
            window.addEventListener('pageshow', function(event) {
                if (swRegistration && !event.persisted) {
                    swRegistration.update().catch(function() {});
                }
            });

            // Wenn ein neuer SW bereit ist, Seite neu laden
            navigator.serviceWorker.addEventListener('controllerchange', function() {
                if (!isReloading) {
                    isReloading = true;
                    console.log('[SW] Controller geändert - lade Seite neu');
                    window.location.reload();
                }
            });

            // Nachrichten vom Service Worker empfangen
            navigator.serviceWorker.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'SW_ACTIVATED') {
                    console.log('[SW] Neuer SW aktiviert:', event.data.cacheVersion);
                }
            });

            // Bei Fokus auf Fenster: Update prüfen
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible' && swRegistration) {
                    swRegistration.update().catch(function() {});
                }
            });
        })();
    </script>
</body>
</html>